# Часть 2
## Ansible роль для конфигурации DHCP сервера
> ## Функции
* Что умеет эта роль?
  * Устанавливать пакет DHCP сервера вне зависимости от версии RedHat like ОС
  * Добавлять 67 порт в разрешения firewall вне зависимости от того что используется (firewalld или iptables)
  * Проверять наличие нужных директорий и создавать их
  * Проверять конфиг DHCP сервера перед тем как добавить его на сервер
* Что не умеет эта роль?
  * Устанавливать пакет DHCP сервера на Debian like ОС
  * Проверять сетевые интерфейсы на наличие соответсвия подсетей указанных в конфиге DHCP сервера
  * Определять, был ли до этого настроен DHCP сервер и дополнять уже существующий конфиг
  * Определять, есть ли в firewall запрещающие правила перед тем как добавлять разрешающие
#### Из всего перечисленного выше, можно сделать вывод что данную роль стоит применять с осторожностью. В первый раз лучше запустить с --diff --check и убедиться что ничего не сломается.
#### Также стоит учитывать что DHCP сервер будет слушать только на том сетевом интерфейсе где адрес соответствует объявленной подсети в файле конфигурации DHCP сервера. Если соответсвия адресов нет, то демон dhcpd упадет в ошибку.
#### Например так:
  ```bash
    ansible-playbook playbooks/dhcp.yml --diff --check
  ```
> ## Зависимости
  * community.general для модуля iptables_state
> ## Доступные переменные
#### *Глобальные переменные*
| Переменная                        | Комментарий                                                            |
| :-------------------------------- | :--------------------------------------------------------------------- |
| `dhcp_server_domain_name`         | Доменное имя сервера                                                   |
| `dhcp_server_dns_servers`         | DNS сервера                                                            |
| `dhcp_server_default_lease_time`  | Время аренды адреса по умолчанию                                       |
| `dhcp_server_max_lease_time`      | Максимальное время аренды адреса по уполчанию                          |
| `dhcp_server_authoritative`       | Является ли сервер ответственным                                       |
| `dhcp_server_log_facility`        | Глубина логирования                                                    |

#### *Переменные подсети*
| Переменная                        | Комментарий                                                            |
| :-------------------------------- | :--------------------------------------------------------------------- |
| `ip`                              | IP адреса сети. (прим `10.1.1.0`)                                      |
| `netmask`                         | Маска подсети (прим `255.255.255.0`)                                   |
| `range_start`                     | Начало пула выдаваемых адресов (прим `10.1.1.2`)                       |
| `range_end`                       | Конец пула выдаваемых адресов  (прим `10.1.1.250`)                     |
| `domain_name`                     | Имя домена подсети                                                     |
| `dns_servers`                     | Адреса DNS серверов подсети                                            |
| `routers`                         | Адрес маршрутизатора подсети (прим `10.1.1.1`)                         |
| `broadcast_address`               | Broadcast адрес (прим `10.1.1.255`)                                    |
| `default_lease_time`              | Время аренды адреса по умолчанию                                       |
| `max_lease_time`                  | Максимальное время аренды адреса подсети                               |

### Также есть возможность настроить интерфейсы сервера для Multihomed DHCP

#### *Переменные интерфейсов*
| Переменная                        | Комментарий                                                            |
| :-------------------------------- | :--------------------------------------------------------------------- |
| `name`                            | Уникальное имя                                                         |
| `mac`                             | MAC адрес сетевого интерфейса                                          |
| `fixip`                           | IP адрес сетевого интерфейса                                           |

> ## Протестированно на:
* CentOS 7
* AlmaLinux 8
* RockyLinux 9 

#### Используемые материалы
* https://github.com/bertvv/ansible-role-dhcp
* https://gitlab.com/paddyoneill/ansible-role-isc-dhcp-server/
* https://jinja.palletsprojects.com/en/3.1.x/templates/#if-expression
* https://access.redhat.com/documentation/ru-ru/red_hat_enterprise_linux/7/html/networking_guide/sec-dhcp-configuring-server
* https://access.redhat.com/documentation/ru-ru/red_hat_enterprise_linux/7/html/networking_guide/sec-configuring_a_multihomed_dhcp_server
* https://wiki.merionet.ru/servernye-resheniya/15/nastrojka-dhcp-servera-na-centos-ili-ubuntu/